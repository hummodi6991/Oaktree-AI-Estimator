name: Import OSM (Riyadh -> RDS)

on:
  workflow_dispatch:
    inputs:
      bbox:
        description: "minLon,minLat,maxLon,maxLat"
        default: "46.20,24.20,47.30,25.10"
        required: true

jobs:
  import:
    runs-on: ubuntu-latest
    # (deliberately no 'timeout-minutes': we rely on the GitHub default max)

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Configure DB env (managed RDS with SSL)
        run: |
          echo "PGHOST=${{ secrets.POSTGRES_HOST }}"       >> $GITHUB_ENV
          echo "PGPORT=${{ secrets.POSTGRES_PORT }}"       >> $GITHUB_ENV
          echo "PGDATABASE=${{ secrets.POSTGRES_DB }}"     >> $GITHUB_ENV
          echo "PGUSER=${{ secrets.POSTGRES_USER }}"       >> $GITHUB_ENV
          echo "PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> $GITHUB_ENV
          echo "PGSSLMODE=require"                        >> $GITHUB_ENV
          echo "PGCONNECT_TIMEOUT=60"                     >> $GITHUB_ENV

      - name: Prepare Overpass query + download (with fallback)
        run: |
          mkdir -p data/osm
          BBOX="${{ inputs.bbox }}"
          cat > data/osm/riyadh.overpass <<'OVP'
          [out:xml][timeout:120];
          {{bbox}};
          (
            way["building"];
            relation["building"];
            way["landuse"];
            relation["landuse"];
          );
          (._;>;);
          out body;
          >; out skel qt;
          OVP
          # bake bbox into the query
          sed -i "s/{{bbox}}/(${BBOX})/" data/osm/riyadh.overpass
          # try main endpoint then fallback
          for EP in https://overpass-api.de/api/interpreter https://overpass.kumi.systems/api/interpreter ; do
            if curl -fsSL --data-urlencode data@data/osm/riyadh.overpass "$EP" -o data/osm/riyadh.osm.xml ; then
              break
            fi
            sleep 10
          done
          head -n1 data/osm/riyadh.osm.xml
          test -s data/osm/riyadh.osm.xml

      - name: Enable PostGIS + hstore + helper function (id extractor)
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          psql "host=$PGHOST port=$PGPORT dbname=$PGDATABASE user=$PGUSER sslmode=$PGSSLMODE" <<'SQL'
          CREATE EXTENSION IF NOT EXISTS postgis;
          CREATE EXTENSION IF NOT EXISTS hstore;

          -- Needed by some planet_osm relation indexes
          CREATE OR REPLACE FUNCTION public.planet_osm_member_ids(members jsonb, membertype character)
          RETURNS bigint[]
          LANGUAGE sql
          IMMUTABLE
          PARALLEL SAFE
          AS $$
            SELECT COALESCE(array_agg( (elem->>'id')::bigint ), '{}')
            FROM jsonb_array_elements(COALESCE(members,'[]'::jsonb)) AS elem
            WHERE upper(left(elem->>'type',1)) = upper(membertype::text);
          $$;
          SQL

      - name: Decide mode (create vs append)
        id: mode
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          # if any main table exists with rows, use --append; otherwise --create
          COUNT=$(psql -At "host=$PGHOST port=$PGPORT dbname=$PGDATABASE user=$PGUSER sslmode=$PGSSLMODE" \
            -c "SELECT COALESCE((SELECT reltuples::bigint FROM pg_class WHERE relname='planet_osm_polygon'),0)")
          if [ "$COUNT" -gt 0 ]; then
            echo "mode=append" >> $GITHUB_OUTPUT
          else
            echo "mode=create" >> $GITHUB_OUTPUT
          fi

      - name: Import with osm2pgsql (${{ steps.mode.outputs.mode }})
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          MODE="${{ steps.mode.outputs.mode }}"
          osm2pgsql $( [ "$MODE" = create ] && echo --create || echo --append ) \
            --slim \
            --latlong \
            --hstore \
            --cache 1024 \
            --prefix planet_osm \
            --style /usr/share/osm2pgsql/default.style \
            -H "$PGHOST" -P "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" \
            data/osm/riyadh.osm.xml

      - name: Touch-up indexes (fast intersects + tag filters)
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          psql "host=$PGHOST port=$PGPORT dbname=$PGDATABASE user=$PGUSER sslmode=$PGSSLMODE" <<'SQL'
          -- geometry
          CREATE INDEX IF NOT EXISTS planet_osm_polygon_way_gist ON planet_osm_polygon USING gist(way);
          CREATE INDEX IF NOT EXISTS planet_osm_line_way_gist    ON planet_osm_line    USING gist(way);

          -- common filters (depends on default.style columns)
          DO $$
          BEGIN
            IF EXISTS (SELECT 1 FROM information_schema.columns
                       WHERE table_name='planet_osm_polygon' AND column_name='landuse') THEN
              EXECUTE 'CREATE INDEX IF NOT EXISTS planet_osm_polygon_landuse_idx ON planet_osm_polygon(landuse)';
            END IF;
            IF EXISTS (SELECT 1 FROM information_schema.columns
                       WHERE table_name='planet_osm_polygon' AND column_name='building') THEN
              EXECUTE 'CREATE INDEX IF NOT EXISTS planet_osm_polygon_building_idx ON planet_osm_polygon(building)';
            END IF;
          END$$;
          SQL

      - name: Smoke test
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          psql "host=$PGHOST port=$PGPORT dbname=$PGDATABASE user=$PGUSER sslmode=$PGSSLMODE" \
            -c "SELECT to_char(now(),'YYYY-MM-DD HH24:MI') as imported_at" \
            -c "SELECT count(*) AS polygons FROM planet_osm_polygon" \
            -c "SELECT count(*) AS lines    FROM planet_osm_line" \
            -c "SELECT count(*) AS points   FROM planet_osm_point"
