name: Import OSM (Riyadh -> RDS)

on:
  workflow_dispatch:
    inputs:
      bbox:
        description: "minLon,minLat,maxLon,maxLat"
        required: true
        default: "46.20,24.20,47.30,25.10"

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      PGHOST: ${{ secrets.POSTGRES_HOST }}
      PGPORT: ${{ secrets.POSTGRES_PORT }}
      PGDATABASE: ${{ secrets.POSTGRES_DB }}
      PGUSER: ${{ secrets.POSTGRES_USER }}
      PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      PGSSLMODE: require
      BBOX_INPUT: ${{ github.event.inputs.bbox || '46.20,24.20,47.30,25.10' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Download Riyadh OSM via Overpass (landuse/building only)
        run: |
          set -euo pipefail
          mkdir -p data/osm && cd data/osm

          # Overpass QL: embed bbox directly; only the tags we need
          cat > riyadh.overpass <<'QL'
          [out:xml][timeout:480];
          (
            nwr(46.20,24.20,47.30,25.10)[landuse];
            nwr(46.20,24.20,47.30,25.10)[building];
          );
          out body;
          >;
          out skel qt;
          QL

          # Try multiple mirrors; show error body, and validate output
          UA="oaktree-estimator-ci/1.0 (+github actions)"
          for URL in \
            https://overpass.kumi.systems/api/interpreter \
            https://lz4.overpass-api.de/api/interpreter \
            https://overpass-api.de/api/interpreter ; do
            echo "Attempting Overpass: $URL"
            if curl -A "$UA" --retry 6 --retry-all-errors --retry-delay 10 \
                 --max-time 600 --connect-timeout 20 \
                 --data-urlencode data@riyadh.overpass \
                 "$URL" -o riyadh.osm.xml ; then
              break
            fi
            echo "Overpass failed at $URL; backing off..."
            sleep 20
          done

          # Basic sanity: must be XML and big enough to be real data (not HTML error)
          head -n1 riyadh.osm.xml || true
          if ! grep -q "<osm" riyadh.osm.xml; then
            echo "ERROR: Overpass did not return OSM XML:"
            sed -n '1,120p' riyadh.osm.xml || true
            exit 2
          fi
          test $(wc -c < riyadh.osm.xml) -gt 500000

      - name: Enable PostGIS + hstore on RDS
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -v ON_ERROR_STOP=1 -c 'CREATE EXTENSION IF NOT EXISTS postgis;'
          psql "$PGURI" -v ON_ERROR_STOP=1 -c 'CREATE EXTENSION IF NOT EXISTS hstore;'

      - name: Import with osm2pgsql (create)
        env:
          PGHOST: ${{ secrets.POSTGRES_HOST }}
          PGPORT: ${{ secrets.POSTGRES_PORT }}
          PGDATABASE: ${{ secrets.POSTGRES_DB }}
          PGUSER: ${{ secrets.POSTGRES_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGSSLMODE: require
          PGOPTIONS: "-c statement_timeout=0 -c idle_in_transaction_session_timeout=0 -c tcp_keepalives_idle=60 -c tcp_keepalives_interval=30 -c tcp_keepalives_count=10"
        run: |
          set -euo pipefail
          cd data/osm
          # Use libpq env vars; avoid interactive --password/--username in CI
          osm2pgsql \
            --create \
            --slim \
            --hstore \
            --latlong \
            --number-processes=2 \
            --prefix planet_osm \
            --database "$PGDATABASE" --host "$PGHOST" --port "$PGPORT" \
            -r xml riyadh.osm.xml

      - name: Touch-up indexes (fast intersects + tag filters)
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=require"
          psql "$PGURI" -v ON_ERROR_STOP=1 <<'SQL'
          CREATE INDEX IF NOT EXISTS idx_planet_osm_polygon_geom
            ON planet_osm_polygon USING GIST (way);
          CREATE INDEX IF NOT EXISTS idx_planet_osm_polygon_landuse
            ON planet_osm_polygon ((tags->'landuse'));
          CREATE INDEX IF NOT EXISTS idx_planet_osm_polygon_building
            ON planet_osm_polygon ((tags->'building'));
          ANALYZE planet_osm_polygon;
          SQL

      - name: Smoke test
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -c "SELECT COUNT(*) AS polygons FROM planet_osm_polygon;"
          psql "$PGURI" -c "SELECT landuse, COUNT(*) FROM planet_osm_polygon GROUP BY 1 ORDER BY 2 DESC LIMIT 10;"
