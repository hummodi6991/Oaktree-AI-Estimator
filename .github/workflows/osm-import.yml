name: Import OSM (Riyadh -> RDS)

on:
  workflow_dispatch:
    inputs:
      bbox:
        description: "minLon,minLat,maxLon,maxLat"
        required: true
        default: "46.20,24.20,47.30,25.10"

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      PGHOST: ${{ secrets.POSTGRES_HOST }}
      PGPORT: ${{ secrets.POSTGRES_PORT }}
      PGDATABASE: ${{ secrets.POSTGRES_DB }}
      PGUSER: ${{ secrets.POSTGRES_USER }}
      PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      PGSSLMODE: require
      BBOX_INPUT: ${{ github.event.inputs.bbox || '46.20,24.20,47.30,25.10' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Download Riyadh OSM via Overpass (landuse/building only)
        run: |
          mkdir -p data/osm
          cat > data/osm/riyadh.overpass <<'EOF'
          [out:xml][timeout:120];
          {{bbox}}
          (
            way["building"];
            relation["building"];
            way["landuse"];
            relation["landuse"];
          );
          (._;>;);
          out body; >; out skel qt;
          EOF

          # Parse bbox input (minLon,minLat,maxLon,maxLat)
          IFS=',' read -r MINLON MINLAT MAXLON MAXLAT <<<"${BBOX_INPUT}"

          if [ -z "${MINLON:-}" ] || [ -z "${MINLAT:-}" ] || [ -z "${MAXLON:-}" ] || [ -z "${MAXLAT:-}" ]; then
            echo "Invalid bbox input: ${BBOX_INPUT}" >&2
            exit 1
          fi

          # Overpass wants bbox as: south,west,north,east (lat,lon,lat,lon)
          SOUTH="$MINLAT"
          WEST="$MINLON"
          NORTH="$MAXLAT"
          EAST="$MAXLON"
          BBOX="${SOUTH},${WEST},${NORTH},${EAST}"

          # Try two mirrors; stop on first success
          for OAPI in \
            https://overpass.kumi.systems/api/interpreter \
            https://overpass-api.de/api/interpreter
          do
            echo "Trying $OAPI ..."
            if curl -fsSL --retry 4 --retry-connrefused \
                 --data-urlencode data@data/osm/riyadh.overpass \
                 --data-urlencode bbox="$BBOX" \
                 "$OAPI" -o data/osm/riyadh.osm.xml; then
              break
            fi
          done

          if [ ! -s data/osm/riyadh.osm.xml ]; then
            echo "Failed to download OSM data from Overpass mirrors" >&2
            exit 3
          fi

          # Sanity checks (must be XML and larger than a few KB)
          head -n1 data/osm/riyadh.osm.xml
          test -s data/osm/riyadh.osm.xml
          file data/osm/riyadh.osm.xml || true
          # Fail if Overpass returned an error page
          grep -m1 -E '<osm|<osm3s' data/osm/riyadh.osm.xml >/dev/null || {
            echo "Overpass did not return OSM XML" >&2
            exit 2
          }

      - name: Enable PostGIS + hstore on RDS
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -v ON_ERROR_STOP=1 -c 'CREATE EXTENSION IF NOT EXISTS postgis;'
          psql "$PGURI" -v ON_ERROR_STOP=1 -c 'CREATE EXTENSION IF NOT EXISTS hstore;'

      - name: Import with osm2pgsql (create)
        run: |
          set -euo pipefail
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=require"
          osm2pgsql \
            --create \
            --slim \
            --latlong \
            --hstore \
            --number-processes=1 \
            --style /usr/share/osm2pgsql/default.style \
            --prefix planet_osm \
            --database "$PGURI" \
            data/osm/riyadh.osm.xml

      - name: Touch-up indexes (fast intersects + tag filters)
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=require"
          psql "$PGURI" -v ON_ERROR_STOP=1 <<'SQL'
          CREATE INDEX IF NOT EXISTS idx_planet_osm_polygon_geom
            ON planet_osm_polygon USING GIST (way);
          CREATE INDEX IF NOT EXISTS idx_planet_osm_polygon_landuse
            ON planet_osm_polygon ((tags->'landuse'));
          CREATE INDEX IF NOT EXISTS idx_planet_osm_polygon_building
            ON planet_osm_polygon ((tags->'building'));
          ANALYZE planet_osm_polygon;
          SQL

      - name: Smoke test
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -c "SELECT COUNT(*) AS polygons FROM planet_osm_polygon;"
          psql "$PGURI" -c "SELECT landuse, COUNT(*) FROM planet_osm_polygon GROUP BY 1 ORDER BY 2 DESC LIMIT 10;"
