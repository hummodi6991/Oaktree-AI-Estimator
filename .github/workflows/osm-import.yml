name: Import OSM (Riyadh -> RDS)

on:
  workflow_dispatch:
    inputs:
      bbox:
        description: "minLon,minLat,maxLon,maxLat"
        required: true
        default: "46.20,24.20,47.30,25.10"

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      PGHOST: ${{ secrets.POSTGRES_HOST }}
      PGPORT: ${{ secrets.POSTGRES_PORT }}
      PGDATABASE: ${{ secrets.POSTGRES_DB }}
      PGUSER: ${{ secrets.POSTGRES_USER }}
      PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      PGSSLMODE: require

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Download Riyadh OSM via Overpass (landuse/building only)
        run: |
          mkdir -p data/osm
          cat > data/osm/riyadh.overpass <<'Q'
          [out:xml][timeout:120];
          {{bbox}}
          (
            way["building"];
            relation["building"];
            way["landuse"];
            relation["landuse"];
          );
          (._;>;);
          out body; >; out skel qt;
          Q

          BBOX="${{ github.event.inputs.bbox }}"

          curl -fL --data-urlencode data@data/osm/riyadh.overpass \
            "https://overpass-api.de/api/interpreter?bbox=$BBOX" \
            -o data/osm/riyadh.osm.xml

          head -n1 data/osm/riyadh.osm.xml
          wc -c data/osm/riyadh.osm.xml

      - name: Enable PostGIS + hstore on RDS
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -v ON_ERROR_STOP=1 -c 'CREATE EXTENSION IF NOT EXISTS postgis;'
          psql "$PGURI" -v ON_ERROR_STOP=1 -c 'CREATE EXTENSION IF NOT EXISTS hstore;'

      - name: Import with osm2pgsql (create)
        run: |
          set -euo pipefail
          cd data/osm
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}&keepalives=1&keepalives_idle=30&keepalives_interval=10&keepalives_count=5"
          osm2pgsql \
            -d "$PGURI" \
            --create --slim --latlong --hstore \
            --number-processes=1 \
            --prefix planet_osm \
            riyadh.osm.xml

      - name: Touch-up indexes (fast intersects + tag filters)
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -v ON_ERROR_STOP=1 <<'SQL'
          CREATE INDEX IF NOT EXISTS idx_osm_poly_way_4326 ON planet_osm_polygon USING GIST (way);
          CREATE INDEX IF NOT EXISTS idx_osm_poly_landuse ON planet_osm_polygon (landuse);
          CREATE INDEX IF NOT EXISTS idx_osm_poly_building ON planet_osm_polygon (building);
          ANALYZE planet_osm_polygon;
          SQL

      - name: Smoke test
        run: |
          PGURI="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=${PGSSLMODE}"
          psql "$PGURI" -c "SELECT COUNT(*) AS polygons FROM planet_osm_polygon;"
          psql "$PGURI" -c "SELECT landuse, COUNT(*) FROM planet_osm_polygon GROUP BY 1 ORDER BY 2 DESC LIMIT 10;"
