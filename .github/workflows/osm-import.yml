name: Import OSM (Riyadh -> RDS)

on:
  workflow_dispatch:
    inputs:
      bbox:
        description: "minLon,minLat,maxLon,maxLat"
        required: true
        default: "46.20,24.20,47.30,25.10"

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Download Riyadh OSM via Overpass (landuse/building only)
        run: |
          mkdir -p data/osm && cd data/osm
          cat > riyadh.overpass <<'QL'
          [out:xml][timeout:480];
          (
            nwr(46.20,24.20,47.30,25.10)[landuse];
            nwr(46.20,24.20,47.30,25.10)[building];
          );
          out body;
          >;
          out skel qt;
          QL
          curl -fsSL --data-urlencode data@riyadh.overpass \
               https://overpass-api.de/api/interpreter -o riyadh.osm.xml
          test $(wc -c < riyadh.osm.xml) -gt 500000 || \
            (echo "Overpass result too small; bailing."; exit 2)
          head -n 1 riyadh.osm.xml  # must be <?xml ...

      - name: Enable PostGIS + hstore on RDS
        env:
          PGHOST: ${{ secrets.POSTGRES_HOST }}
          PGPORT: ${{ secrets.POSTGRES_PORT }}
          PGDATABASE: ${{ secrets.POSTGRES_DB }}
          PGUSER: ${{ secrets.POSTGRES_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGSSLMODE: require
          PGOPTIONS: "-c statement_timeout=0 -c idle_in_transaction_session_timeout=0 -c tcp_keepalives_idle=60 -c tcp_keepalives_interval=30 -c tcp_keepalives_count=10"
        run: |
          psql -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS postgis;"
          psql -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS hstore;"

      - name: Import with osm2pgsql (create)
        env:
          PGHOST: ${{ secrets.POSTGRES_HOST }}
          PGPORT: ${{ secrets.POSTGRES_PORT }}
          PGDATABASE: ${{ secrets.POSTGRES_DB }}
          PGUSER: ${{ secrets.POSTGRES_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGSSLMODE: require
          PGOPTIONS: "-c statement_timeout=0 -c idle_in_transaction_session_timeout=0 -c tcp_keepalives_idle=60 -c tcp_keepalives_interval=30 -c tcp_keepalives_count=10"
        run: |
          cd data/osm
          # Small AOI â†’ --slim is still recommended so queries use indexes
          osm2pgsql \
            --create \
            --slim \
            --hstore \
            --latlong \
            --number-processes=2 \
            --prefix planet_osm \
            --database "$PGDATABASE" --host "$PGHOST" --port "$PGPORT" \
            --username "$PGUSER" --password \
            -r xml riyadh.osm.xml

      - name: Touch-up indexes (fast intersects for the API)
        env:
          PGHOST: ${{ secrets.POSTGRES_HOST }}
          PGPORT: ${{ secrets.POSTGRES_PORT }}
          PGDATABASE: ${{ secrets.POSTGRES_DB }}
          PGUSER: ${{ secrets.POSTGRES_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGSSLMODE: require
        run: |
          psql -v ON_ERROR_STOP=1 <<'SQL'
          -- Make sure these exist. osm2pgsql usually creates GIST on way.
          CREATE INDEX IF NOT EXISTS planet_osm_polygon_landuse_idx ON planet_osm_polygon(landuse);
          CREATE INDEX IF NOT EXISTS planet_osm_polygon_building_idx ON planet_osm_polygon(building);
          ANALYZE planet_osm_polygon;
          SQL

      - name: Smoke test
        env:
          PGHOST: ${{ secrets.POSTGRES_HOST }}
          PGPORT: ${{ secrets.POSTGRES_PORT }}
          PGDATABASE: ${{ secrets.POSTGRES_DB }}
          PGUSER: ${{ secrets.POSTGRES_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGSSLMODE: require
        run: |
          psql -c "SELECT to_char(now(),'YYYY-MM-DD HH24:MI') as imported_at,
                          (SELECT count(*) FROM planet_osm_polygon) AS polygons;"
