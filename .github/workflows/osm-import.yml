name: Import OSM (Riyadh -> RDS)

on:
  workflow_dispatch:
    inputs:
      bbox:
        description: "minLon,minLat,maxLon,maxLat"
        default: "46.20,24.20,47.30,25.10"
        required: true

jobs:
  import:
    runs-on: ubuntu-latest
    # (deliberately no 'timeout-minutes': we rely on the GitHub default max)

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Configure DB env (managed RDS with SSL)
        run: |
          echo "PGHOST=${{ secrets.POSTGRES_HOST }}"       >> $GITHUB_ENV
          echo "PGPORT=${{ secrets.POSTGRES_PORT }}"       >> $GITHUB_ENV
          echo "PGDATABASE=${{ secrets.POSTGRES_DB }}"     >> $GITHUB_ENV
          echo "PGUSER=${{ secrets.POSTGRES_USER }}"       >> $GITHUB_ENV
          echo "PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> $GITHUB_ENV
          echo "PGSSLMODE=require"                        >> $GITHUB_ENV
          echo "PGCONNECT_TIMEOUT=60"                     >> $GITHUB_ENV
          echo "BBOX=${{ inputs.bbox }}"                  >> $GITHUB_ENV

      - name: Prepare Overpass query + download (with fallback)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/osm

          # Write Overpass QL with a {{bbox}} placeholder so we can reuse it
          cat > data/osm/riyadh.template.overpass <<'EOF'
[out:xml][timeout:120];
({{bbox}});
(
  way["building"];
  relation["building"];
  way["landuse"];
  relation["landuse"];
);
(._;>;);
out body; >; out skel qt;
EOF

          # Replace {{bbox}} with the configured BBOX (west,south,east,north)
          sed "s/{{bbox}}/${{ env.BBOX }}/g" data/osm/riyadh.template.overpass > data/osm/riyadh.overpass

          # Try multiple Overpass mirrors (kumi first, then official).
          tried=0
          for O in https://overpass.kumi.systems/api/interpreter https://overpass-api.de/api/interpreter; do
            tried=$((tried+1))
            if curl -fsSL -o data/osm/riyadh.osm.xml \
                 --data-urlencode data@data/osm/riyadh.overpass \
                 "$O"; then
              echo "Downloaded OSM extract via $O"
              break
            else
              echo "Warn: Overpass attempt $tried failed ($O); trying next mirror…" >&2
            fi
          done

          # Sanity check (should be tens of MB and start with <?xml …>)
          head -n 1 data/osm/riyadh.osm.xml
          test -s data/osm/riyadh.osm.xml

      - name: Enable PostGIS + hstore + helper (id extractor)
        shell: bash
        run: |
          set -euo pipefail
          PGURL="postgresql://${{ env.PGUSER }}:${{ env.PGPASSWORD }}@${{ env.PGHOST }}:${{ env.PGPORT }}/${{ env.PGDATABASE }}?sslmode=${{ env.PGSSLMODE }}"
          psql "$PGURL" -c "CREATE EXTENSION IF NOT EXISTS postgis;"
          psql "$PGURL" -c "CREATE EXTENSION IF NOT EXISTS hstore;"

      - name: Decide mode (create vs append)
        id: mode
        shell: bash
        run: |
          set -euo pipefail
          PGURL="postgresql://${{ env.PGUSER }}:${{ env.PGPASSWORD }}@${{ env.PGHOST }}:${{ env.PGPORT }}/${{ env.PGDATABASE }}?sslmode=${{ env.PGSSLMODE }}"
          if psql "$PGURL" -tAc "select to_regclass('public.planet_osm_point') is not null" | grep -q t; then
            echo "mode=append" >> $GITHUB_OUTPUT
          else
            echo "mode=create" >> $GITHUB_OUTPUT
          fi

      - name: Import with osm2pgsql (${{ steps.mode.outputs.mode }})
        shell: bash
        timeout-minutes: 350  # near max; see note below
        run: |
          set -euo pipefail
          MODE="${{ steps.mode.outputs.mode }}"
          PGURL="postgresql://${{ env.PGUSER }}:${{ env.PGPASSWORD }}@${{ env.PGHOST }}:${{ env.PGPORT }}/${{ env.PGDATABASE }}?sslmode=${{ env.PGSSLMODE }}"
          # Keep EPSG:4326 so API code that expects WGS84 continues to work
          osm2pgsql \
            --${MODE} \
            --slim \
            --latlong \
            --hstore \
            --prefix planet_osm \
            --style /usr/share/osm2pgsql/default.style \
            --cache 1024 \
            -d "$PGURL" \
            data/osm/riyadh.osm.xml

      - name: Touch-up indexes (fast intersects + tags)
        shell: bash
        run: |
          set -euo pipefail
          PGURL="postgresql://${{ env.PGUSER }}:${{ env.PGPASSWORD }}@${{ env.PGHOST }}:${{ env.PGPORT }}/${{ env.PGDATABASE }}?sslmode=${{ env.PGSSLMODE }}"
          psql "$PGURL" -v ON_ERROR_STOP=1 <<'SQL'
          DO $$ BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='planet_osm_polygon_way_idx') THEN
              EXECUTE 'CREATE INDEX planet_osm_polygon_way_idx ON planet_osm_polygon USING GIST(way);';
            END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE schemaname='public' AND indexname='planet_osm_polygon_tags_idx') THEN
              EXECUTE 'CREATE INDEX planet_osm_polygon_tags_idx ON planet_osm_polygon USING GIN(tags);';
            END IF;
          END $$;
          SQL

      - name: Smoke test
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          psql "host=$PGHOST port=$PGPORT dbname=$PGDATABASE user=$PGUSER sslmode=$PGSSLMODE" \
            -c "SELECT to_char(now(),'YYYY-MM-DD HH24:MI') as imported_at" \
            -c "SELECT count(*) AS polygons FROM planet_osm_polygon" \
            -c "SELECT count(*) AS lines    FROM planet_osm_line" \
            -c "SELECT count(*) AS points   FROM planet_osm_point"
