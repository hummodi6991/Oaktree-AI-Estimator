name: Import OSM (Riyadh → RDS)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Force 'create' or 'append' (leave empty for auto)"
        required: false
        default: ""

env:
  # west,south,east,north (same bbox you’ve used elsewhere)
  BBOX: "46.20,24.20,47.30,25.10"
  OVERPASS_MAIN: "https://overpass-api.de/api/interpreter"
  OVERPASS_FALLBACK: "https://overpass.kumi.systems/api/interpreter"

jobs:
  import:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y osm2pgsql postgresql-client curl jq

      - name: Configure DB env (managed RDS with SSL)
        env:
          PGHOST_S: ${{ secrets.POSTGRES_HOST }}
          PGPORT_S: ${{ secrets.POSTGRES_PORT }}
          PGDB_S:   ${{ secrets.POSTGRES_DB }}
          PGUSER_S: ${{ secrets.POSTGRES_USER }}
          PGPASS_S: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          {
            echo "PGHOST=${PGHOST_S}"
            echo "PGPORT=${PGPORT_S}"
            echo "PGDATABASE=${PGDB_S}"
            echo "PGUSER=${PGUSER_S}"
            echo "PGPASSWORD=${PGPASS_S}"
            echo "PGSSLMODE=require"
          } >> "$GITHUB_ENV"

      - name: Prepare Overpass query + download (with fallback)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/osm
          # Write a tiny Overpass script with a placeholder {{bbox}}
          cat > data/osm/riyadh.overpass <<'Q'
          [out:xml][timeout:180];
          (
            way["building"]({{bbox}});
            relation["building"]({{bbox}});
            way["landuse"]({{bbox}});
            relation["landuse"]({{bbox}});
          );
          (._;>;);
          out body;
          Q

          # Fill the bbox and POST it (URL-encoded) to Overpass
          QUERY="$(sed "s/{{bbox}}/${BBOX}/g" data/osm/riyadh.overpass)"
          for URL in "$OVERPASS_MAIN" "$OVERPASS_FALLBACK"; do
            if curl --fail --silent --show-error --retry 6 --retry-all-errors \
                 --max-time 120 --data-urlencode "data=$QUERY" \
                 "$URL" -o data/osm/riyadh.osm.xml; then
              break
            fi
          done

          # Quick sanity checks
          test -s data/osm/riyadh.osm.xml
          head -n1 data/osm/riyadh.osm.xml | grep -q '<?xml'

      - name: Enable PostGIS + hstore + helper function (id extractor)
        run: |
          set -eu
          PGMODE="sslmode=require"
          PGURL="postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@${{ secrets.POSTGRES_HOST }}:${{ secrets.POSTGRES_PORT }}/${{ secrets.POSTGRES_DB }}?${PGMODE}"

          # Extensions (idempotent)
          psql "$PGURL" -c "CREATE EXTENSION IF NOT EXISTS postgis;"
          psql "$PGURL" -c "CREATE EXTENSION IF NOT EXISTS hstore;"

          # Ensure we can create in public (some managed PGs restrict this)
          psql "$PGURL" -v ON_ERROR_STOP=1 <<'SQL'
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM   information_schema.role_table_grants
              WHERE  grantee = current_user
            ) THEN
              -- If this fails, your DB role lacks privileges; grant in RDS console or with admin.
              RAISE NOTICE 'Ensure CREATE on schema public for %', current_user;
            END IF;
          END $$;
          SQL

          # Helper that extracts member ids from planet_osm_rels.members (jsonb)
          psql "$PGURL" -v ON_ERROR_STOP=1 <<'SQL'
          CREATE OR REPLACE FUNCTION public.planet_osm_member_ids(members jsonb, t text)
          RETURNS bigint[] LANGUAGE sql IMMUTABLE PARALLEL SAFE AS $$
            SELECT coalesce(array_agg( (e->>'ref')::bigint ORDER BY (e->>'ref')::bigint ), '{}')
            FROM jsonb_array_elements(members) e
            WHERE CASE upper(t)
                    WHEN 'N' THEN e->>'type'='node'
                    WHEN 'W' THEN e->>'type'='way'
                    WHEN 'R' THEN e->>'type'='relation'
                    ELSE false
                  END;
          $$;

          -- Wrapper so calls like 'N'::character work too
          CREATE OR REPLACE FUNCTION public.planet_osm_member_ids(members jsonb, t character)
          RETURNS bigint[] LANGUAGE sql IMMUTABLE PARALLEL SAFE AS $$
            SELECT public.planet_osm_member_ids(members, t::text);
          $$;
          SQL

      - name: Decide mode (create vs append)
        id: mode
        run: |
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "value=${{ github.event.inputs.mode }}" >> "$GITHUB_OUTPUT"
          elif psql -XtAc "SELECT to_regclass('public.planet_osm_polygon')" | grep -q planet_osm_polygon; then
            echo "value=append" >> "$GITHUB_OUTPUT"
          else
            echo "value=create" >> "$GITHUB_OUTPUT"
          fi

      - name: Import with osm2pgsql (${{ steps.mode.outputs.value }})
        run: |
          set -euo pipefail
          if [ "${{ steps.mode.outputs.value }}" = "create" ]; then
            osm2pgsql --create --slim --latlong --hstore \
              --style /usr/share/osm2pgsql/default.style \
              --number-processes 1 \
              --prefix planet_osm \
              -d "$PGDATABASE" -H "$PGHOST" -P "$PGPORT" -U "$PGUSER" \
              data/osm/riyadh.osm.xml
          else
            osm2pgsql --append --slim --latlong --hstore \
              --style /usr/share/osm2pgsql/default.style \
              --number-processes 1 \
              --prefix planet_osm \
              -d "$PGDATABASE" -H "$PGHOST" -P "$PGPORT" -U "$PGUSER" \
              data/osm/riyadh.osm.xml
          fi

      - name: Touch-up indexes (fast intersects + tag filters)
        run: |
          psql -v ON_ERROR_STOP=1 <<'SQL'
          CREATE INDEX IF NOT EXISTS planet_osm_polygon_way_gix
            ON planet_osm_polygon USING GIST (way);
          CREATE INDEX IF NOT EXISTS planet_osm_polygon_landuse_txt
            ON planet_osm_polygon ((tags->'landuse'));
          CREATE INDEX IF NOT EXISTS planet_osm_polygon_building_txt
            ON planet_osm_polygon ((tags->'building'));
          ANALYZE planet_osm_polygon;
          SQL

      - name: Smoke test
        run: |
          psql -XtAc "SELECT to_char(NOW(),'YYYY-MM-DD HH24:MI'), count(*) FROM planet_osm_polygon;"
